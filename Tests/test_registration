from data import Person, RandomData
from locators import RegistrationPageLocators, AuthPageLocators
from urls import URLS
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.remote.webdriver import WebDriver


class TestRegistrationPage:

    def test_registration_success(self, driver: WebDriver):
        """Успешная регистрация"""
        driver.get(URLS.REG_PAGE_URL)

        # Ожидание видимости кнопки регистрации
        wait = WebDriverWait(driver, 5)
        registration_button_present = EC.visibility_of_element_located(RegistrationPageLocators.registration_btn)
        wait.until(registration_button_present)

        # Заполнение полей формы
        driver.find_element(*RegistrationPageLocators.name_input).send_keys(RandomData.user_name)
        driver.find_element(*RegistrationPageLocators.email_input).send_keys(RandomData.email)
        driver.find_element(*RegistrationPageLocators.password_input).send_keys(RandomData.password)

        # Клик на кнопку регистрации
        driver.find_element(*RegistrationPageLocators.registration_btn).click()

        # Ожидание появления кнопки "Войти в аккаунт"
        account_button_located = EC.presence_of_element_located(AuthPageLocators.login_account_btn)
        WebDriverWait(driver, 5).until(account_button_located)

        # Проверка успешности регистрации
        login_button = driver.find_element(*AuthPageLocators.login_account_btn)
        url_check = driver.current_url == URLS.AUTH_PAGE_URL
        button_check = login_button.is_displayed()

        assert button_check and url_check, "Проверка регистрации не пройдена: URL или видимость элемента не соответствуют ожиданиям"


    def test_registration_incorrect_password_check_error(self, driver: WebDriver):
        """Проверка ошибки при некорректном пароле"""
        driver.get(URLS.REG_PAGE_URL)

        wait = WebDriverWait(driver, 5)
        button_clickable = EC.element_to_be_clickable(RegistrationPageLocators.registration_btn)
        wait.until(button_clickable)

        driver.find_element(*RegistrationPageLocators.name_input).send_keys(Person.user_name)
        driver.find_element(*RegistrationPageLocators.email_input).send_keys(Person.email)
        driver.find_element(*RegistrationPageLocators.password_input).send_keys("12345")
        driver.find_element(*RegistrationPageLocators.registration_btn).click()

        wait = WebDriverWait(driver, 3)
        error_visible = EC.visibility_of_element_located(RegistrationPageLocators.error_message_incorrect_password)
        wait.until(error_visible)

        error_element = driver.find_element(*RegistrationPageLocators.error_message_incorrect_password)
        error_text = error_element.text

        url_valid = driver.current_url == URLS.REG_PAGE_URL
        text_valid = error_text == 'Некорректный пароль'

        assert url_valid and text_valid, "Некорректный URL или текст ошибки"

    def test_double_registration_check_error(self, driver: WebDriver):
        """Проверка ошибки при повторной регистрации"""
        driver.get(URLS.REG_PAGE_URL)

        wait = WebDriverWait(driver, 5)
        button_present = EC.visibility_of_element_located(RegistrationPageLocators.registration_btn)
        wait.until(button_present)

        driver.find_element(*RegistrationPageLocators.name_input).send_keys(Person.user_name)
        driver.find_element(*RegistrationPageLocators.email_input).send_keys(Person.email)
        driver.find_element(*RegistrationPageLocators.password_input).send_keys(Person.password)
        driver.find_element(*RegistrationPageLocators.registration_btn).click()

        wait = WebDriverWait(driver, 3)
        error_visible = EC.visibility_of_element_located(RegistrationPageLocators.error_message_double_reg)
        wait.until(error_visible)

        error_text_element = driver.find_element(*RegistrationPageLocators.error_message_double_reg)
        error_text = error_text_element.text
        url_valid = driver.current_url == URLS.REG_PAGE_URL
        text_valid = error_text == 'Такой пользователь уже существует'


        assert url_valid and text_valid, "Некорректный URL или текст ошибки"
